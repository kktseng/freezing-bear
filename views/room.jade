extends layout

block head
  script(src='/javascripts/lib/fabric.js')
  script(src='/javascripts/lib/canvasHelpers.js')

block content
  .row-fluid
    .span6
      canvas.canvas#c(width='500', height='500')
    .span5
      .scrollbox.span8#chatbox
      .scrollbox.span4#userlist
      .row-fluid
        .input-append
          input.span8#chatInput(type='text')
          button.btn#chatSubmit Submit

block javascript
  script

    function updateUserList(userlist) {
      $('#userlist').text('');
      userlist.sort();
      userlist.forEach(function(user) {
        $('#userlist').append(newline('userlist') + user);
      });
    }

    $(function() {
      var userlist = [];

      // socketio
      var socket = io.connect('http://localhost:3000');
      socket.on('connect', function() {
        socket.emit('joinRoom', '#{room}');
      });
      socket.on('userlist', function(users) {
        userlist = users;
        updateUserList(userlist);
      });
      socket.on('updateChat', function(username, message) {
        $('#chatbox').append(newline('chatbox') + username + ': ' + message);
      });
      socket.on('userConnect', function(username) {
        userlist.push(username);
        updateUserList(userlist);
      });
      socket.on('userDisconnect', function(username) {
        if(userlist.indexOf(username) >= 0) {
          userlist.splice(userlist.indexOf(username), 1);
          updateUserList(userlist);
        }
      });

      // prompt username
      var username = prompt('What is your username?');
      if(username === '')
        username = 'Anon';
      socket.emit('setUser', username);

      // submitting chat messages
      $('#chatSubmit').click(function() {
        socket.emit('sendChat', $('#chatInput').val());
      });

      // canvas
      var canvas = new fabric.Canvas('c');
    
      /*
      for (var i = 0, len = 15; i < len; i++) {
        fabric.Image.fromURL('http://www.cbre.com.hk/ServiceLines/PublishingImages/Alex%20Leung.jpg', function(img) {
          img.set({
            left: fabric.util.getRandomInt(0, 600),
            top: fabric.util.getRandomInt(0, 500),
            angle: fabric.util.getRandomInt(0, 90)
          });

          img.perPixelTargetFind = true;
          img.targetFindTolerance = 4;

          img.scale(fabric.util.getRandomInt(50, 100) / 100);

          canvas.add(img);
        });
      }
      */

      fabric.Image.fromURL('http://images.nationalgeographic.com/wpf/media-live/photos/000/005/cache/domestic-cat_516_600x450.jpg', function(img) {
        img.set({
          left: 100,
          top: 100,
          width: 100,
          height: 100,
          angle: 0
        });

        canvas.add(img);
      });

      var cs = [{ 'url' : 'http://images.nationalgeographic.com/wpf/media-live/photos/000/005/cache/domestic-cat_516_600x450.jpg',
                  'left' : 500,
                  'up' : 500,
                  'width' : 100,
                  'height' : 100,
                  'angle' : 0 }, 
                { 'url' : 'http://images.nationalgeographic.com/wpf/media-live/photos/000/005/cache/domestic-cat_516_600x450.jpg',
                  'left' : 1000,
                  'up' : 1000,
                  'width' : 100,
                  'height' : 100,
                  'angle' : 0
                }];

      setTimeout(function(){updateCanvas(canvas, cs)}, 1000);

      // handle canvas events
      canvas.observe('object:modified', sendState);
      canvas.observe('object:scaling', cappedSendState);
      canvas.observe('object:moving', cappedSendState);
      canvas.observe('object:rotating', cappedSendState);

    });